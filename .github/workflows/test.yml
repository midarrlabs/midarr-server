name: Test

on:
  push:
    branches:
      - '**'

env:
  MIX_ENV: test

jobs:

  test:
    name: OTP ${{matrix.otp}} / Elixir ${{matrix.elixir}}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        otp: [ '24' ]
        elixir: [ '1.13.4' ]
    steps:
      - uses: actions/checkout@v2
      - run: sudo groupadd media
      - run: sudo adduser --system --no-create-home --ingroup media radarr
      - run: sudo usermod -a -G media radarr
      - run: sudo mkdir -p /var/lib/radarr
      - run: sudo chown -R radarr:media /var/lib/radarr
      - run: sudo chmod 775 /var/lib/radarr
      - run: sudo apt install curl sqlite3
      - run: wget --content-disposition "http://radarr.servarr.com/v1/update/master/updatefile?os=linux&runtime=netcore&arch=x64"
      - run: tar -xvzf Radarr*.linux*.tar.gz
      - run: sudo mv Radarr /opt
      - run: sudo chown radarr:media -R /opt/Radarr
      - run: cat <<EOF | tee /etc/systemd/system/radarr.service >/dev/null
              [Unit]
              Description=radarr Daemon
              After=syslog.target network.target
              [Service]
              User=radarr
              Group=media
              UMask=0002
              Type=simple
              ExecStart=/opt/radarr -nobrowser -data=/var/lib/radarr
              TimeoutStopSec=20
              KillMode=process
              Restart=on-failure
              [Install]
              WantedBy=multi-user.target
              EOF